import json

from django.http import JsonResponse
from django.views import View
from django.db.models import Q

from product.models import Product, Brand
from ootd.models import Ootd
from user.models import User

class Search(View):
    def get(self, request):
        keyword = request.GET.get('keyword')
        
        brands  = Brand.objects.filter(name__icontains=keyword)
        products = Product.objects.filter(Q(title__icontains=keyword) | Q(description__icontains=keyword))
        ootds   = Ootd.objects.filter(Q(title__icontains=keyword) | Q(description__icontains=keyword))
        users = User.objects.filter(nickname__icontains=keyword)

        brand_list = [{
            'brand_name' : brand.name,
            'brand_image' : brand.image_url
        } for brand in brands]

        product_list = [{
            'product_brand' : product.brand.name,
            'product_image' : product.main_image_url,
            'description' : product.description,
            'discount_rate' : product.discount_rate,
            'discount_price' : format(int(round(product.price-(product.discount_rate * product.price),-2)),'.2f')
        } for product in products]

        ootd_list = [{
            'author' : ootd.user.nickname,
            'ootd_images' : [image.image_url for image in ootd.ootdimageurl_set.all()],
            'description' : ootd.description,
            'like'   : ootd.like_user.count(),
            'comment_count' : ootd.comment_set.count(),
            'product_title' : ootd.product.title,
            'product_image' : ootd.product.main_image_url,
            'product_discount_rate' : ootd.product.discount_rate,
            'product_discount_price' : format(int(round(ootd.product.price - (ootd.product.price * ootd.porudct.discount_rate),-2)),'.2f')

        } for ootd in ootds]


